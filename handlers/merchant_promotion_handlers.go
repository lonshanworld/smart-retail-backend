package handlers\n\nimport (\n\t\"app/database\"\n\t\"app/models\"\n\t\"context\"\n\t\"log\"\n\t\"strconv\"\n\n\t\"github.com/gofiber/fiber/v2\"\n\t\"github.com/golang-jwt/jwt/v4\"\n)\n\n// PromotionCreateRequest defines the structure for creating a promotion.\ntype PromotionCreateRequest struct {\n\tName        string   `json:\"name\"`\n\tDescription string   `json:\"description\"`\n\tPromoType   string   `json:\"type\"`\n\tPromoValue  float64  `json:\"value\"`\n\tStartDate   string   `json:\"startDate\"`\n\tEndDate     string   `json:\"endDate\"`\n\tShopID      string   `json:\"shopId\"`\n\tProductIDs  []string `json:\"productIds\"` // IDs of products this promotion applies to\n}\n\n// HandleCreatePromotion creates a new promotion for the merchant.\nfunc HandleCreatePromotion(c *fiber.Ctx) error {\n\tdb := database.GetDB()\n\tctx := context.Background()\n\n\tuser := c.Locals(\"user\").(*jwt.Token)\n\tclaims := user.Claims.(jwt.MapClaims)\n\tmerchantID := claims[\"userId\"].(string)\n\n\tvar req PromotionCreateRequest\n\tif err := c.BodyParser(&req); err != nil {\n\t\treturn c.Status(fiber.StatusBadRequest).JSON(fiber.Map{\"success\": false, \"message\": \"Invalid request body\"})\n\t}\n\n\ttx, err := db.Begin(ctx)\n\tif err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to start transaction\"})\n\t}\n\tdefer tx.Rollback(ctx)\n\n\t// Insert the promotion\n\tpromoQuery := `\n        INSERT INTO promotions (merchant_id, shop_id, name, description, promo_type, promo_value, start_date, end_date)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING id\n    `\n\tvar promotionID string\n\terr = tx.QueryRow(ctx, promoQuery, merchantID, req.ShopID, req.Name, req.Description, req.PromoType, req.PromoValue, req.StartDate, req.EndDate).Scan(&promotionID)\n\tif err != nil {\n\t\tlog.Printf(\"Error creating promotion: %v\", err)\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to create promotion\"})\n\t}\n\n\t// Link products to the promotion\n\tif len(req.ProductIDs) > 0 {\n\t\tstmt, err := tx.Prepare(ctx, \"insert_promo_product\", \"INSERT INTO promotion_products (promotion_id, inventory_item_id) VALUES ($1, $2)\")\n\t\tif err != nil {\n\t\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to prepare product link statement\"})\n\t\t}\n\t\tfor _, productID := range req.ProductIDs {\n\t\t\tif _, err := tx.Exec(ctx, stmt.Name, promotionID, productID); err != nil {\n\t\t\t\tlog.Printf(\"Error linking product %s to promotion: %v\", productID, err)\n\t\t\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to link product to promotion\"})\n\t\t\t}\n\t\t}\n\t}\n\n\tif err := tx.Commit(ctx); err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to commit transaction\"})\n\t}\n\n\treturn c.Status(fiber.StatusCreated).JSON(fiber.Map{\"success\": true, \"message\": \"Promotion created successfully\", \"data\": promotionID})\n}\n\n// HandleListPromotions lists all promotions for the authenticated merchant.\nfunc HandleListPromotions(c *fiber.Ctx) error {\n\tdb := database.GetDB()\n\tctx := context.Background()\n\n\tuser := c.Locals(\"user\").(*jwt.Token)\n\tclaims := user.Claims.(jwt.MapClaims)\n\tmerchantID := claims[\"userId\"].(string)\n\n\tpage, _ := strconv.Atoi(c.Query(\"page\", \"1\"))\n\tpageSize, _ := strconv.Atoi(c.Query(\"pageSize\", \"10\"))\n\toffset := (page - 1) * pageSize\n\n\tquery := `\n        SELECT id, name, description, promo_type, promo_value, start_date, end_date, shop_id, is_active, created_at, updated_at\n        FROM promotions\n        WHERE merchant_id = $1\n        ORDER BY created_at DESC\n        LIMIT $2 OFFSET $3\n    `\n\trows, err := db.Query(ctx, query, merchantID, pageSize, offset)\n\tif err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to retrieve promotions\"})\n\t}\n\tdefer rows.Close()\n\n\tpromotions := make([]models.Promotion, 0)\n\tfor rows.Next() {\n\t\tvar p models.Promotion\n\t\tif err := rows.Scan(&p.ID, &p.Name, &p.Description, &p.PromoType, &p.PromoValue, &p.StartDate, &p.EndDate, &p.ShopID, &p.IsActive, &p.CreatedAt, &p.UpdatedAt); err != nil {\n\t\t\tlog.Printf(\"Error scanning promotion: %v\", err)\n\t\t\tcontinue\n\t\t}\n\t\tpromotions = append(promotions, p)\n\t}\n\n\t// Get total count for pagination\n\tvar totalItems int\n\tcountQuery := \"SELECT COUNT(*) FROM promotions WHERE merchant_id = $1\"\n\tif err := db.QueryRow(ctx, countQuery, merchantID).Scan(&totalItems); err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to count promotions\"})\n\t}\n\n\treturn c.JSON(fiber.Map{\n\t\t\"success\": true,\n\t\t\"data\": fiber.Map{\n\t\t\t\"items\":       promotions,\n\t\t\t\"totalItems\":  totalItems,\n\t\t\t\"currentPage\": page,\n\t\t\t\"totalPages\":  (totalItems + pageSize - 1) / pageSize,\n\t\t},\n\t})\n}\n\n// HandleUpdatePromotion updates an existing promotion.\nfunc HandleUpdatePromotion(c *fiber.Ctx) error {\n\tdb := database.GetDB()\n\tctx := context.Background()\n\n\tuser := c.Locals(\"user\").(*jwt.Token)\n\tclaims := user.Claims.(jwt.MapClaims)\n\tmerchantID := claims[\"userId\"].(string)\n\n\tpromotionID := c.Params(\"id\")\n\tvar req PromotionCreateRequest\n\tif err := c.BodyParser(&req); err != nil {\n\t\treturn c.Status(fiber.StatusBadRequest).JSON(fiber.Map{\"success\": false, \"message\": \"Invalid request body\"})\n\t}\n\n\ttx, err := db.Begin(ctx)\n\tif err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to start transaction\"})\n\t}\n\tdefer tx.Rollback(ctx)\n\n\t// Update the promotion\n\tpromoQuery := `\n        UPDATE promotions\n        SET name = $1, description = $2, promo_type = $3, promo_value = $4, start_date = $5, end_date = $6, shop_id = $7\n        WHERE id = $8 AND merchant_id = $9\n    `\n\t_, err = tx.Exec(ctx, promoQuery, req.Name, req.Description, req.PromoType, req.PromoValue, req.StartDate, req.EndDate, req.ShopID, promotionID, merchantID)\n\tif err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to update promotion\"})\n\t}\n\n\t// Delete existing product links\n\tif _, err := tx.Exec(ctx, \"DELETE FROM promotion_products WHERE promotion_id = $1\", promotionID); err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to update product links\"})\n\t}\n\n\t// Add new product links\n\tif len(req.ProductIDs) > 0 {\n\t\tstmt, err := tx.Prepare(ctx, \"update_promo_product\", \"INSERT INTO promotion_products (promotion_id, inventory_item_id) VALUES ($1, $2)\")\n\t\tif err != nil {\n\t\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to prepare product link statement\"})\n\t\t}\n\t\tfor _, productID := range req.ProductIDs {\n\t\t\tif _, err := tx.Exec(ctx, stmt.Name, promotionID, productID); err != nil {\n\t\t\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to link product to promotion\"})\n\t\t\t}\n\t\t}\n\t}\n\n\tif err := tx.Commit(ctx); err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to commit transaction\"})\n\t}\n\n\treturn c.Status(fiber.StatusOK).JSON(fiber.Map{\"success\": true, \"message\": \"Promotion updated successfully\"})\n}\n\n// HandleDeletePromotion deletes a promotion.\nfunc HandleDeletePromotion(c *fiber.Ctx) error {\n\tdb := database.GetDB()\n\tctx := context.Background()\n\n\tuser := c.Locals(\"user\}).(*jwt.Token)\n\tclaims := user.Claims.(jwt.MapClaims)\n\tmerchantID := claims[\"userId\"].(string)\n\n\tpromotionID := c.Params(\"id\")\n\n\tquery := \"DELETE FROM promotions WHERE id = $1 AND merchant_id = $2\"\n\tcommandTag, err := db.Exec(ctx, query, promotionID, merchantID)\n\tif err != nil {\n\t\treturn c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{\"success\": false, \"message\": \"Failed to delete promotion\"})\n\t}\n\tif commandTag.RowsAffected() == 0 {\n\t\treturn c.Status(fiber.StatusNotFound).JSON(fiber.Map{\"success\": false, \"message\": \"Promotion not found or you do not have permission to delete it\"})\n\t}\n\n\treturn c.Status(fiber.StatusOK).JSON(fiber.Map{\"success\": true, \"message\": \"Promotion deleted successfully\"})\n}\n